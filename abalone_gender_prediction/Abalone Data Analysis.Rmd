---
title: "Abalone Data Analysis"
author:
- "Melvin Tjandradjaja"
- "ZZSC5855-Multivariate Analysis for Data Scientists"
- "University of New South Wales"
output:
  html_notebook: default
---

## Packages

```{r}
library(here)
library(dplyr)
library(readr)
library(MASS)
library(GGally)
library(e1071)
library(Hotelling)
library(ICSNP)
library(rrcov)
library(mvtnorm)
library(MVN)
```

## 1. Introduction

We have been engaged by an Australian diving equipment manufacturing company to propose a statistical model that can be used to predict an abalone's gender and incorporate the model into their new generation integrated goggle and caliper sets.

In addition to this, we are to develop an algorithm that can predict an abalone's shucked and viscera weight (interior measurements) given its length, diameter, and height (exterior measurements). The algorithm will then use the predicted interior measurements to calculate the abalone's estimated worth (given the day's abalone shucked and viscera weight dollar value per gram) and interior measurements prediction interval 90 percent of the time.

The abalone data (obtained from our client) consist of 4177 abalone observation with the following information;

1.  Gender (Male, Female, or Infant) 

2.  Length (longest shell measurement in mm) 

3.  Diameter (perpendicular to length in mm)

4.  Height (with meat in shell in mm)

5.  Whole weight (whole weight in grams)

6.  Shucked weight (weight of meat in grams)

7.  Viscera weight (gut weight after bleeding in grams)

8.  Shell weight (after being dried in grams)

9.  Rings (number of rings (can be used to estimate the mollusc's age: adding 1.5 gives the age in years)

For the purpose of this analysis we are only interested on the length, diameter, height, shucked weight, and viscera weight measurement.

We start the analysis by loading the abalone data.

```{r}
abalone <- read.csv('abalone.csv')
```

Once the data has been loaded, we will proceed with the following tasks;

-   Cleaning the data

-   Observing data points segregation

-   Learning the shape of the data

-   Deciding on the models that will be suitable for the client's requirements

-   Categorizing the gender variable in the dataset and split the dataset

-   Fitting a statistical model for gender prediction and observe the prediction accuracy

-   Fitting a statistical model for interior measurements' predictions and observe the accuracy

-   Testing the algorithm for an abalone value estimation and interior measurements prediction interval output

## 2. Data Cleaning

The data cleaning tasks will involve removing null values and outliers from the dataset.

Null values removal will use the R na.omit() function whereas outliers removal will use the z-score method.

```{r}
#find and remove null values
abalone <- na.omit(abalone)

#find absolute value of z-score for each value in each column
z_scores <- as.data.frame(sapply(abalone[-1], function(df) (abs(df-mean(df))/sd(df))))

#only keep rows in dataframe with all z-scores less than absolute value of 3 
no_outliers <- abalone[!rowSums(z_scores>3), ]
```

## 3. Data Segregation Analysis

For this analysis, we want to see how segregated the female, male, and infant abalones' exterior measurements data points are.

We generate the following plots to begin our observations.

```{r}

# Generating the required plots for our observation 
ggplot(no_outliers,aes(x=Length,y=Diameter,col=Sex))+geom_point()
ggplot(no_outliers,aes(x=Length,y=Height,col=Sex))+geom_point()
ggplot(no_outliers,aes(x=Diameter,y=Height,col=Sex))+geom_point()

```

The plots are color coded based on the abalone's gender (Female: F, Infant: I, Male: M) and they seem to show almost no segregation between the 3 populations' data points.

This might indicate little distinctions between the three populations' exterior measurements.

Given this observation, we want to see how much different the population means are in terms of their exterior measurements by using Hotelling T squared test.

We will perform the test to observe the followings;

-   Differences between the male and female population

-   Differences between the male and infant population

The test between male and female population is as follows;

```{r}
f <- subset(no_outliers, Sex=='F', select=c(Length,Diameter,Height))
m <- subset(no_outliers, Sex=='M', select=c(Length,Diameter,Height))

T2.test(f,m)
```

The small p-value less than 0.05 indicates no evidence to suggest that the male and female population exterior measurements' means are not different.

The test between male and infant population is as follows;

```{r}
i <- subset(no_outliers, Sex=='I', select=c(Length,Diameter,Height))

T2.test(m,i)
```

The small p-value less than 0.05 indicates no evidence to suggest that the male and infant population exterior measurements' means are not different.

As summarized from the first test, the following table shows the mean values of female and male exterior measurements along with their differences.

|             | Length | Diameter | Height |
|:-----------:|:------:|:--------:|:------:|
| Mean Female | 115.08 |  90.33   | 31.13  |
|  Mean Male  | 111.24 |  86.99   | 29.86  |
| Difference  |  3.84  |   3.34   |  1.27  |

As summarized from the second test, the following table shows the mean values of male and infant exterior measurements along with their differences.

|             | Length | Diameter | Height |
|:-----------:|:------:|:--------:|:------:|
|  Mean Male  | 111.24 |  86.99   | 29.86  |
| Mean Infant | 86.16  |  65.77   | 21.78  |
| Difference  | 25.08  |  21.22   |  8.08  |

On average, the female abalones are not that much bigger than the male abalones. Although, they are both much bigger than the infant abalones.

Under these circumstances, the low distinction between female and male abalones (in terms of the average exterior measurements) can lead to poor gender classifications.

## 4. Data Shape Analysis

For this analysis, we want observe the following relationships;

-   Length vs. Shucked Weight

-   Diameter vs. Shucked Weight

-   Height vs. Shucked Weight

-   Length vs. Viscera Weight

-   Diameter vs. Viscera Weight

-   Height vs. Viscera Weight

We start our observation by generating the following plots.

```{r}
ggplot(no_outliers,aes(x=Length,y=Shucked.weight))+geom_point(colour='red')
ggplot(no_outliers,aes(x=Diameter,y=Shucked.weight))+geom_point(colour='blue')
ggplot(no_outliers,aes(x=Height,y=Shucked.weight))+geom_point(colour='green')

ggplot(no_outliers,aes(x=Length,y=Viscera.weight))+geom_point(colour='orange')
ggplot(no_outliers,aes(x=Diameter,y=Viscera.weight))+geom_point(colour='yellow')
ggplot(no_outliers,aes(x=Height,y=Viscera.weight))+geom_point(colour='purple')
```

The plots seem to show the interior measurements having a logarithmic relationship with the exterior measurements.

## 5. Statistical Models in Consideration

In regard to considering the statistical model to be used for gender prediction, we want to see if the abalone populations are multivariate normal or not by using multivariate normal test.

The Multivariate Normal test for the abalone populations is as follows;

```{r}
mvn(no_outliers[-1], mvnTest = 'mardia', univariateTest = 'SW')
```

It seems that the abalone populations are not multivariate normal.

Under this circumstance, the classification boundaries will not be clearly defined and a non-linear technique will be required to handle the gender classification.

We will consider Support Vector Machine (SVM) for the gender prediction.

Since the interior measurements have a logarithmic relationship with the exterior measurements, we will consider Multivariate Linear model (MLM) with logarithm for predicting an abalone's interior measurements to calculate its estimated dollar value and Multiple Linear Regression (MLR) models with logarithm for predicting an abalone's interior measurements to calculate its actual value prediction interval.

## 6. Categorizing Gender and Splitting the Dataset

We apply factor() to categorize the gender variable in preparation of using SVM to predict an abalone's gender and split the clean dataset into a training and test dataset.

```{r}

#Applying factor() to the gender variable to ensure that the SVM fitting works
abalone2 <- no_outliers %>% mutate(Sex=factor(Sex))

#Splitting the clean dataset into training and test dataset
sample <- sample(c(TRUE,FALSE), nrow(abalone2), 
                 replace=TRUE, prob=c(0.9,0.1))

train_dataset <- abalone2[sample, ]

test_dataset <- abalone2[!sample, ]
```

The training dataset will account for 90% of the clean dataset to ensure the models having sufficient observation to learn from to make their predictions.

The test dataset will account for 10% of the clean dataset and serve as unseen data for the models to make realistic predictions from.

## 7. SVM Model Fitting for Gender Prediction

The SVM model fitting process involves the followings;

-   Finding the best parameters for the SVM model fitting

-   Fitting the SVM model using the best parameters with the training dataset defined during the dataset splitting process

-   Observing the model's prediction accuracy value

We will consider SVM with Sigmoid, Linear, and Radial kernel for the fittings.

### 7.1 Sigmoid SVM Model Parameters Tuning

Parameters tuning for the Sigmoid SVM model is as follows;

```{r}

# Tuning to find the best model for SVM Sigmoid with training dataset
tuning_svm <- tune.svm(Sex~Length+Diameter+Height, data=train_dataset, 
                        kernel='sigmoid', cost = 10^(-1:1), gamma = 10^(-1:1),
                        coef0 = 10^(-1:1))

summary(tuning_svm)

tuning_svm$best.parameters

tuning_svm$best.model
```

It seems that Sigmoid SVM model (with gamma at 0.1, coef0 at 1, cost at 0.1, and classification type C-classification) has the lowest error at 0.4918206.

We will proceed with using these parameters for the Sigmoid SVM model fitting.

### 7.2 Sigmoid SVM Model Fitting

Sigmoid SVM model fitting with the best parameters obtained from the tuning process is as follows;

```{r}

# SVM sigmoid model fitting with training dataset
set.seed(5)
abalone_svm_sig <- svm(Sex~Length+Diameter+Height, data=train_dataset, cross=10,  
                        kernel = 'sigmoid', cost = 0.1, gamma = 0.1, 
                        coef0 = 1, type = 'C-classification')

# Viewing diagnostic to detemine the prediction accuracy value
summary(abalone_svm_sig)

```

The total accuracy seems to be at 51.98 percent.

This indicates that the model is 51.98 percent correct at a time when predicting an abalone's gender.

### 7.3 Linear SVM Model Parameters Tuning

Parameters tuning for the Linear SVM model is as follows;

```{r}

# Tuning to find the best model for SVM linear with training dataset
tuning_svm <- tune.svm(Sex~Length+Diameter+Height, data=train_dataset, 
                       kernel='linear', cost = 10^(-1:1))

summary(tuning_svm)

tuning_svm$best.parameters

tuning_svm$best.model
```

It seems that Linear SVM model (with cost at 0.1 and classification type C-classification) has the lowest error at 0.477944.

We will proceed with using these parameters for the Linear SVM model fitting.

### 7.4 Linear SVM Model Fitting

Linear SVM model fitting with the best parameters obtained from the tuning process is as follows;

```{r}

# SVM linear model fitting with training dataset
set.seed(5)
abalone_svm_lin <- svm(Sex~Length+Diameter+Height, data=train_dataset, cross=10, 
                      kernel = 'linear', cost = 0.1, type = 'C-classification')

# Viewing diagnostic to detemine the prediction accuracy value
summary(abalone_svm_lin)
```

The total accuracy seems to be at 52.29 percent. This indicates that the model is 52.29 percent correct at a time when predicting an abalone's gender.

### 7.5 Radial SVM Model Parameters Tuning

Parameters tuning for the Radial SVM model is as follows;

```{r}

# Tuning to find the best model for SVM radial with training dataset
tuning_svm <- tune.svm(Sex~Length+Diameter+Height, data=train_dataset, 
                       kernel='radial', cost = 10^(-1:1), gamma = 10^(-1:1))

summary(tuning_svm)

tuning_svm$best.parameters

tuning_svm$best.model
```

It seems that Radial SVM model (with gamma at 0.1, cost at 1, and classification type C-classification) has the lowest error at 0.480197.

We will proceed with using these parameters for the Radial SVM model fitting.

### 7.6 Radial SVM Model Fitting

Radial SVM model fitting with the best parameters obtained from the tuning process is as follows;

```{r}

# SVM radial model fitting with training dataset
set.seed(5)
abalone_svm_rad <- svm(Sex~Length+Diameter+Height, data=train_dataset, cross=10, 
                      kernel = 'radial', cost = 1, gamma = 0.1, type = 'C-classification')

# Viewing diagnostic to detemine the prediction accuracy value
summary(abalone_svm_rad)
```

The total accuracy seems to be at 52.15 percent. This indicates that the model is 52.15 percent correct at a time when predicting an abalone's gender.

### 7.7 Consolidated Prediction Accuracy Values

The following table shows the SVM models' prediction accuracy.

|             | Prediction Accuracy (%) |
|:-----------:|:-----------------------:|
| SVM Sigmoid |          51.98          |
| SVM Linear  |          52.29          |
| SVM Radial  |          52.15          |

All of the models' prediction accuracy seem to be low which indicates the models' poor prediction performances.

## 8. MLM and MLR Models Fitting with Logarithmic

The MLM and MLR models fitting process will involve the followings;

-   Fitting the models using the training dataset defined during the dataset splitting process

-   Using MANOVA test to observe the exterior measurements' significance in predicting the interior measurements

-   Calculating the models' Mean Squared Error (MSE) to observe the models prediction errors

MLM and MLR models fitting are as follows;

```{r}
# MLM fitting with training dataset
set.seed(5)
abalone_lm <- lm(cbind(log(Shucked.weight),log(Viscera.weight)) ~ Length+Diameter+Height, data=train_dataset)

# Viewing the diagnostic output
summary(abalone_lm)

# MLR model fitting with training dataset
set.seed(5)
abalone_lm2 <- lm(log(Shucked.weight) ~ Length+Diameter+Height, data=train_dataset)

# MLR model fitting with training dataset
set.seed(5)
abalone_lm3 <- lm(log(Viscera.weight) ~ Length+Diameter+Height, data=train_dataset)

```

MLM MANOVA test is as follows;

```{r}
# MANOVA test to determine the exterior measurements' prediction significance
anova(abalone_lm)
```

The exterior measurements' p-values from the MANOVA test seems to be less than 0.05.

This indicates that the abalone exterior measurements are highly significant in predicting the interior measurements.

MLM's MSEs are as follows;

```{r}
# Calculating the MSEs for the interior measurements' predictions 
mean(abalone_lm$residuals[,1]^2)
mean(abalone_lm$residuals[,2]^2)
```

MLR models' MSEs are as follows:

```{r}
# Calculating the MSE for the shucked weight's prediction 
mean(abalone_lm2$residuals^2)

# Calculating the MSE for the viscera weight's prediction 
mean(abalone_lm3$residuals^2)
```

The following tables show the MLM's and MLR models' prediction errors.

|      MLM       | Prediction Error |
|:--------------:|:----------------:|
| Shucked Weight |      0.0544      |
| Viscera Weight |      0.0553      |

|   MLR Model    | Prediction Error |
|:--------------:|:----------------:|
| Shucked Weight |      0.0544      |
| Viscera Weight |      0.0553      |

The low prediction error values denote small differences between the actual and predicted interior measurements' values.

This indicates the MLM and the MLR models are performing well in predicting the interior measurements.

## 9. Testing the Abalone Value Estimator Algorithm

The abalone value estimator algorithm will use the exterior measurements' coefficients (calculated during the MLM fitting process) to predict the interior measurement (given new exterior measurements data) and utilize the predicted values to calculate the abalone's estimated value (given the day's abalone shucked and viscera meat dollar value per gram).

The algorithm will then use the MLR models (given new exterior measurements data) to calculate the interior measurements' prediction interval.

```{r}
profit_index <- function(len, dia, hgt, vsh, vvis){
  
  # Calculating the predicted shucked weight value given new exterior measurement
  # data
  xsh <- 0.023146*len + 0.010424*dia + 0.006689*hgt + 0.557434 
  
  # Calculating the predicted viscera weight value given new exterior measurement
  # data
  xvis <-  0.020089*len + 0.009633*dia + 0.018709*hgt - 0.077706
  
  # Since the predicted interior measurements' values are logarithmic,
  # we need to take the exponent of those values to revert them back 
  # to values with the proper scaling
  
  # This has to be done in order to avoid miscalculation for the abalone's
  # estimated dollar value
  S <- exp(xsh) * vsh + exp(xvis) * vvis
  
  # Calculating the interior measurements' prediction intervals given new exterior 
  # measurement data
  shw_pred <- predict.lm(abalone_lm2, newdata=data.frame(Length=len, 
                         Diameter=dia, Height=hgt),interval='predict', 
                         level=0.9)
  
  visw_pred <- predict.lm(abalone_lm3, newdata=data.frame(Length=len, 
                          Diameter=dia, Height=hgt), interval='predict', 
                          level=0.9)
  
  # Since the prediction intervals' values are also logirithmic, we also need to take
  # the exponent of those values to revert them back to values with the proper scaling 
  shw_pred <- exp(shw_pred)
  
  visw_pred <- exp(visw_pred)
  
  PI <- shw_pred[,2:3] + visw_pred[,2:3]
  
  return(list(S, PI))
}

```

The algorithm test with new data is as follows;

```{r}
# Testing the algorithm with new exterior measurements data
l <- test_dataset[21:25,]$Length
d <- test_dataset[21:25,]$Diameter
h <- test_dataset[21:25,]$Height

profit_index(l,d,h,0.7,0.5)
```
